<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HBR Praktijkcoach</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .compact-chat {
            width: 100%;
            max-width: 400px;
            height: 600px;
            margin: 20px auto;
            border: 2px solid #f97316;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        @media (max-width: 640px) {
            .compact-chat {
                width: 95%;
                height: 90vh;
                margin: 10px auto;
            }
        }
        
        .message-container {
            scrollbar-width: thin;
            scrollbar-color: #f97316 #f3f4f6;
        }
        
        .message-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .message-container::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        
        .message-container::-webkit-scrollbar-thumb {
            background: #f97316;
            border-radius: 3px;
        }

        /* Fix voor input focus */
        input[type="text"] {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

<div id="app"></div>

<script>
// Simple state management
let appState = {
    messages: [],
    inputValue: '',
    studentNumber: '',
    isLoggedIn: false,
    currentMenu: '',
    hasAskedMenu: false
};

// Input references for focus management
let currentInput = null;

// Knowledge base
const knowledgeBase = {
    ingredienten: {
        'mirepoix': {
            description: 'Mengsel van wortel, ui en selderij in gelijke delen.',
            usage: 'Basis voor soepen en sauzen'
        },
        'tarwegluten': {
            description: 'Eiwit uit tarwe dat elasticiteit geeft aan deeg.',
            usage: 'Voor broodstructuur'
        },
        'roux': {
            description: 'Boter en bloem samen bakken voor sauzen.',
            usage: 'Sauzen dikker maken'
        },
        'liaison': {
            description: 'Eigeel met room voor het binden van soepen.',
            usage: 'Soep dikker maken'
        }
    },
    snijtechnieken: {
        'brunoise': {
            description: 'Fijne blokjes van 2-3mm.',
            veiligheid: 'Vingers krom houden!'
        },
        'julienne': {
            description: 'Fijne reepjes 4cm x 2-3mm.',
            veiligheid: 'Rustig aan!'
        },
        'carré': {
            description: 'Vierkante blokjes van 1cm.',
            veiligheid: 'Stabiele snijplank!'
        }
    },
    kooktechnieken: {
        'blancheren': {
            description: 'Kort koken, dan ijswater.',
            method: 'Kokend water → groente → ijswater'
        },
        'glaceren': {
            description: 'Glanzend maken met boter en honing.',
            method: 'Eerst blancheren, dan glaceren'
        }
    }
};

const menuDatabase = {
    '21': { title: 'Paprikasoep, paella, crema catalana', technieken: ['Brunoise'] },
    '22': { title: 'Courgettekoekjes, bruschetta, carbonara', technieken: ['Grillen'] },
    '23': { title: 'Pannenkoekrolletjes, kip, dauphinoise', technieken: ['Carré'] },
    '24': { title: 'Groentesoep, gehaktbrood, glaceerde wortel', technieken: ['Julienne'] },
    '25': { title: 'Tomatensoep, gevulde pasta', technieken: ['Pasta maken'] }
};

// Helper functions
function createElement(tag, props = {}, ...children) {
    const element = document.createElement(tag);
    
    Object.entries(props).forEach(([key, value]) => {
        if (key.startsWith('on') && typeof value === 'function') {
            element.addEventListener(key.slice(2).toLowerCase(), value);
        } else if (key === 'className') {
            element.className = value;
        } else if (key === 'style' && typeof value === 'object') {
            Object.assign(element.style, value);
        } else if (key !== 'ref') {
            element.setAttribute(key, value);
        }
    });
    
    // Handle ref
    if (props.ref) {
        props.ref(element);
    }
    
    children.flat().forEach(child => {
        if (typeof child === 'string' || typeof child === 'number') {
            element.appendChild(document.createTextNode(child));
        } else if (child instanceof Node) {
            element.appendChild(child);
        }
    });
    
    return element;
}

// Message analysis
function analyzeMessage(message) {
    const lower = message.toLowerCase().trim();
    
    const menuMatch = lower.match(/menu\s*(\d+)/);
    if (menuMatch && !appState.currentMenu) {
        return { type: 'menu_detection', menuNumber: menuMatch[1] };
    }

    if (['mes', 'snijden', 'frituur', 'oven', 'heet'].some(w => lower.includes(w))) {
        return { type: 'veiligheid' };
    }

    const patterns = {
        reproductie: /wat is|wat zijn|definitie/,
        training: /is dit goed|klopt dit|wat moet ik nu/,
        transfer: /hoe groot|hoe dik|waarom/,
        inzicht: /planning|wat eerst|volgorde/
    };

    for (const [level, pattern] of Object.entries(patterns)) {
        if (pattern.test(lower)) {
            return { type: level, level };
        }
    }

    for (const [category, items] of Object.entries(knowledgeBase)) {
        for (const [item, info] of Object.entries(items)) {
            if (lower.includes(item)) {
                return { 
                    type: category.slice(0, -1), 
                    item, 
                    info,
                    level: category === 'ingredienten' ? 'reproductie' : 'transfer'
                };
            }
        }
    }

    return { type: 'algemeen' };
}

// Response generation
function generateResponse(analysis) {
    if (!appState.currentMenu && !appState.hasAskedMenu && analysis.type !== 'menu_detection') {
        appState.hasAskedMenu = true;
        return {
            text: 'Hoi! Welk menu heb je vandaag?',
            followUp: 'Typ "menu 23"',
            rttiLevel: 'start'
        };
    }

    const responses = {
        menu_detection: () => {
            const num = analysis.menuNumber;
            appState.currentMenu = num;
            const menu = menuDatabase[num];
            return menu ? {
                text: `Menu ${num}: ${menu.title}`,
                followUp: `Technieken: ${menu.technieken.join(', ')}`,
                rttiLevel: 'info'
            } : {
                text: `Menu ${num} genoteerd!`,
                followUp: 'Lees je recept door!',
                rttiLevel: 'info'
            };
        },
        veiligheid: () => ({
            text: '⚠️ STOP! Veiligheid eerst!',
            followUp: 'Roep de docent!',
            isUrgent: true
        }),
        reproductie: () => ({
            text: 'Check je recept voor de exacte informatie',
            followUp: 'Specifieke details staan daar!',
            rttiLevel: 'R'
        }),
        training: () => ({
            text: 'Vergelijk met je recept',
            followUp: 'Lijkt het erop? Dan goed!',
            rttiLevel: 'T1'
        }),
        transfer: () => ({
            text: 'Welke techniek staat in je recept?',
            followUp: 'Brunoise, julienne, etc?',
            rttiLevel: 'T2'
        }),
        inzicht: () => ({
            text: 'Wat duurt het langst?',
            followUp: 'Daarmee beginnen!',
            rttiLevel: 'I'
        }),
        ingredient: () => ({
            text: `${analysis.item}: ${analysis.info.description}`,
            followUp: `Gebruik: ${analysis.info.usage}`,
            rttiLevel: 'R'
        }),
        snijtechniek: () => ({
            text: `${analysis.item}: ${analysis.info.description}`,
            followUp: `Veiligheid: ${analysis.info.veiligheid}`,
            rttiLevel: 'T2'
        }),
        kooktechniek: () => ({
            text: `${analysis.item}: ${analysis.info.description}`,
            followUp: `${analysis.info.method}`,
            rttiLevel: 'T2'
        }),
        algemeen: () => ({
            text: 'Check je recept!',
            followUp: 'Specifieke vraag?',
            rttiLevel: 'help'
        })
    };

    return (responses[analysis.type] || responses.algemeen)();
}

// Send message
function handleSendMessage() {
    const input = appState.inputValue.trim();
    if (!input) return;

    const userMsg = { type: 'user', content: input, timestamp: Date.now() };
    const analysis = analyzeMessage(input);
    const response = generateResponse(analysis);
    const botMsg = { type: 'bot', ...response, timestamp: Date.now() };

    appState.messages = [...appState.messages, userMsg, botMsg];
    appState.inputValue = '';
    
    render();
    
    // Focus terug naar input
    setTimeout(() => {
        if (currentInput) {
            currentInput.focus();
        }
        const container = document.querySelector('.message-container');
        if (container) container.scrollTop = container.scrollHeight;
    }, 100);
}

// Login
function handleLogin() {
    const num = appState.studentNumber;
    if (num.length >= 3) {
        appState.isLoggedIn = true;
        const isTeacher = ['docent', 'test'].includes(num.toLowerCase());
        const isGuest = num.toLowerCase() === 'gast';
        
        let welcome = 'Hoi! Ik ben je praktijkcoach. Welk menu?';
        if (isTeacher) welcome = 'Hallo docent! Testmodus actief.';
        else if (isGuest) welcome = 'Welkom! Welk menu heb je?';
        
        appState.messages = [{
            type: 'bot',
            text: welcome,
            followUp: 'Test: "Wat is mirepoix?" vs "Hoe groot snijden?"',
            timestamp: Date.now(),
            rttiLevel: 'intro'
        }];
        
        render();
    }
}

// Set quick message
function setQuickMessage(text) {
    appState.inputValue = text;
    render();
    // Focus input na update
    setTimeout(() => {
        if (currentInput) {
            currentInput.focus();
        }
    }, 50);
}

// Create message element
function createMessage(message, index) {
    const isUser = message.type === 'user';
    const messageDiv = createElement('div', {
        className: `flex ${isUser ? 'justify-end' : 'justify-start'} mb-2`
    });

    const contentDiv = createElement('div', {
        className: `max-w-xs px-3 py-2 rounded-lg text-sm ${
            isUser ? 'bg-orange-500 text-white' : 
            message.isUrgent ? 'bg-red-100 border border-red-300' : 'bg-white border shadow-sm'
        }`
    });

    const textDiv = createElement('div', {
        className: message.isUrgent ? 'text-red-700 font-bold' : ''
    }, message.text || message.content);

    contentDiv.appendChild(textDiv);

    if (message.rttiLevel && !isUser) {
        const colors = {
            'R': 'bg-blue-400', 'T1': 'bg-green-400', 'T2': 'bg-yellow-400', 'I': 'bg-purple-400'
        };
        const label = createElement('div', { className: 'mt-1' },
            createElement('span', {
                className: `inline-block px-2 py-1 rounded text-white text-xs font-bold ${colors[message.rttiLevel] || 'bg-gray-400'}`
            }, message.rttiLevel)
        );
        contentDiv.appendChild(label);
    }

    if (message.followUp) {
        const followUpDiv = createElement('div', {
            className: `mt-2 p-2 rounded text-xs ${
                message.isUrgent ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-600'
            }`
        }, message.followUp);
        contentDiv.appendChild(followUpDiv);
    }

    messageDiv.appendChild(contentDiv);
    return messageDiv;
}

// Create quick button
function createQuickButton(text, label, color) {
    return createElement('button', {
        className: `flex-1 ${color} px-2 py-1 rounded text-xs hover:opacity-75`,
        onclick: () => setQuickMessage(text)
    }, label);
}

// Main render function
function render() {
    const app = document.getElementById('app');
    app.innerHTML = '';

    if (!appState.isLoggedIn) {
        const loginDiv = createElement('div', { className: 'compact-chat' },
            createElement('div', { className: 'bg-orange-500 text-white p-3 rounded-t-lg' },
                createElement('h1', { className: 'font-bold text-center' }, 'HBR Praktijkcoach')
            ),
            createElement('div', { className: 'flex-1 p-4 flex flex-col justify-center' },
                createElement('div', { className: 'text-center mb-4' },
                    createElement('h2', { className: 'text-lg font-bold text-orange-600 mb-1' }, 'Praktijkcoach'),
                    createElement('p', { className: 'text-xs text-gray-600' }, 'VMBO HBR + RTTI')
                ),
                createElement('div', { className: 'space-y-3' },
                    createElement('input', {
                        type: 'text',
                        placeholder: 'Leerlingnummer of "gast"',
                        className: 'w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-orange-500',
                        value: appState.studentNumber,
                        oninput: (e) => {
                            appState.studentNumber = e.target.value;
                        },
                        onkeypress: (e) => {
                            if (e.key === 'Enter') handleLogin();
                        },
                        ref: (el) => { if (el) el.focus(); }
                    }),
                    createElement('button', {
                        className: 'w-full bg-orange-500 text-white p-3 rounded hover:bg-orange-600 disabled:bg-gray-300 transition-colors',
                        onclick: handleLogin,
                        disabled: appState.studentNumber.length < 3
                    }, 'Start Coach')
                )
            )
        );
        app.appendChild(loginDiv);
        return;
    }

    // Main chat interface
    const chatDiv = createElement('div', { className: 'compact-chat' },
        createElement('div', { className: 'bg-orange-500 text-white p-3 rounded-t-lg flex justify-between items-center' },
            createElement('div', { className: 'flex items-center space-x-2' },
                createElement('h1', { className: 'font-bold text-sm' }, 'HBR Praktijkcoach'),
                appState.currentMenu ? createElement('div', { className: 'bg-orange-600 px-2 py-1 rounded text-xs' }, `Menu ${appState.currentMenu}`) : null
            )
        ),
        createElement('div', { className: 'flex-1 overflow-y-auto p-3 space-y-2 bg-gray-50 message-container' },
            ...appState.messages.map(createMessage)
        ),
        createElement('div', { className: 'border-t bg-white p-3' },
            createElement('div', { className: 'flex space-x-1 mb-2' },
                createQuickButton('Wat is mirepoix?', 'R', 'bg-blue-100 text-blue-700'),
                createQuickButton('Is dit goed?', 'T1', 'bg-green-100 text-green-700'),
                createQuickButton('Hoe groot snijden?', 'T2', 'bg-yellow-100 text-yellow-700'),
                createQuickButton('Planning maken?', 'I', 'bg-purple-100 text-purple-700')
            ),
            createElement('div', { className: 'flex space-x-2' },
                createElement('input', {
                    type: 'text',
                    placeholder: 'Stel je vraag...',
                    className: 'flex-1 p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-orange-500',
                    value: appState.inputValue,
                    oninput: (e) => {
                        appState.inputValue = e.target.value;
                    },
                    onkeypress: (e) => {
                        if (e.key === 'Enter') handleSendMessage();
                    },
                    ref: (el) => {
                        currentInput = el;
                        if (el) {
                            // Focus after render
                            setTimeout(() => el.focus(), 50);
                        }
                    }
                }),
                createElement('button', {
                    className: 'bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition-colors',
                    onclick: handleSendMessage
                }, '→')
            )
        )
    );

    app.appendChild(chatDiv);
}

// Initial render
render();
</script>

</body>
</html>
</script>

</body>
</html>
